version: '2.3'
services:
  redis:
    image: redislabs/redisgraph:2.2.15
    ports:
      - "6379:6379"
    mem_limit: 4gb
    environment:
      - PYTHONUNBUFFERED=0

  jaeger:
    image: jaegertracing/all-in-one:1.14
    command: --log-level=debug
    ports:
      - 5775:5775/udp
      - 6831:6831/udp
      - 6832:6832/udp
      - 5778:5778
      - 16686:16686
      - 14268:14268
      - 9411:9411

  client-manager:
    image: registry.insight-centre.org/sit/mps/felipe-phd/client-manager:master
    command: python /service/client_manager/run.py
    depends_on:
      - redis

    environment:
      - PYTHONUNBUFFERED=0
      - REDIS_ADDRESS=${REDIS_ADDRESS}
      - REDIS_PORT=${REDIS_PORT}
      - TRACER_REPORTING_HOST=${TRACER_REPORTING_HOST}
      - TRACER_REPORTING_PORT=${TRACER_REPORTING_PORT}
      - SERVICE_STREAM_KEY=${CLIENT_MANAGER_STREAM_KEY}
      - PUB_EVENT_TYPE_QUERY_CREATED=${EVENT_TYPE_QUERY_CREATED}
      - PUB_EVENT_TYPE_QUERY_REMOVED=${EVENT_TYPE_QUERY_REMOVED}
      - LISTEN_EVENT_TYPE_QUERY_RECEIVED=${EVENT_TYPE_QUERY_RECEIVED}
      - LISTEN_EVENT_TYPE_QUERY_DELETION_REQUESTED=${EVENT_TYPE_QUERY_DELETION_REQUESTED}
      - LISTEN_EVENT_TYPE_PUBLISHER_CREATED=${EVENT_TYPE_PUBLISHER_CREATED}
      - LISTEN_EVENT_TYPE_PUBLISHER_REMOVED=${EVENT_TYPE_PUBLISHER_REMOVED}
      - LISTEN_EVENT_TYPE_SERVICE_WORKER_ANNOUNCED=${EVENT_TYPE_SERVICE_WORKER_ANNOUNCED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}

  adaptation-monitor:
    image: registry.insight-centre.org/sit/mps/felipe-phd/adaptation-monitor:master
    command: python /service/adaptation_monitor/run.py
    depends_on:
      - redis

    environment:
      - PYTHONUNBUFFERED=0
      - REDIS_ADDRESS=${REDIS_ADDRESS}
      - REDIS_PORT=${REDIS_PORT}
      - TRACER_REPORTING_HOST=${TRACER_REPORTING_HOST}
      - TRACER_REPORTING_PORT=${TRACER_REPORTING_PORT}
      - SERVICE_STREAM_KEY=${ADAPTATION_MONITOR_STREAM_KEY}
      - LISTEN_EVENT_TYPE_SERVICE_WORKER_ANNOUNCED=${EVENT_TYPE_SERVICE_WORKER_ANNOUNCED}
      - LISTEN_EVENT_TYPE_REPEAT_MONITOR_STREAMS_SIZE_REQUESTED=${EVENT_TYPE_REPEAT_MONITOR_STREAMS_SIZE_REQUESTED}
      - PUB_EVENT_TYPE_REPEAT_MONITOR_STREAMS_SIZE_REQUESTED=${EVENT_TYPE_REPEAT_MONITOR_STREAMS_SIZE_REQUESTED}
      - PUB_EVENT_TYPE_SERVICE_WORKERS_STREAM_MONITORED=${EVENT_TYPE_SERVICE_WORKERS_STREAM_MONITORED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}

  adaptation-analyser:
    image: registry.insight-centre.org/sit/mps/felipe-phd/adaptation-analyser:master
    command: python /service/adaptation_analyser/run.py
    depends_on:
      - redis

    environment:
      - PYTHONUNBUFFERED=0
      - REDIS_ADDRESS=${REDIS_ADDRESS}
      - REDIS_PORT=${REDIS_PORT}
      - TRACER_REPORTING_HOST=${TRACER_REPORTING_HOST}
      - TRACER_REPORTING_PORT=${TRACER_REPORTING_PORT}
      - SERVICE_STREAM_KEY=${ADAPTATION_ANALYSER_STREAM_KEY}
      - LISTEN_EVENT_TYPE_SERVICE_WORKERS_STREAM_MONITORED=${EVENT_TYPE_SERVICE_WORKERS_STREAM_MONITORED}
      - LISTEN_EVENT_TYPE_QUERY_CREATED=${EVENT_TYPE_QUERY_CREATED}
      - LISTEN_EVENT_TYPE_SERVICE_WORKER_ANNOUNCED=${EVENT_TYPE_SERVICE_WORKER_ANNOUNCED}
      - LISTEN_EVENT_TYPE_SCHEDULING_PLAN_EXECUTED=${EVENT_TYPE_SCHEDULING_PLAN_EXECUTED}
      - PUB_EVENT_TYPE_NEW_QUERY_SCHEDULING_PLAN_REQUESTED=${EVENT_TYPE_NEW_QUERY_SCHEDULING_PLAN_REQUESTED}
      - PUB_EVENT_TYPE_SERVICE_WORKER_OVERLOADED_PLAN_REQUESTED=${EVENT_TYPE_SERVICE_WORKER_OVERLOADED_PLAN_REQUESTED}
      - PUB_EVENT_TYPE_SERVICE_WORKER_BEST_IDLE_REQUESTED=${EVENT_TYPE_SERVICE_WORKER_BEST_IDLE_REQUESTED}
      - PUB_EVENT_TYPE_UNNECESSARY_LOAD_SHEDDING_REQUESTED=${EVENT_TYPE_UNNECESSARY_LOAD_SHEDDING_REQUESTED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}

  adaptation-planner:
    image: registry.insight-centre.org/sit/mps/felipe-phd/adaptation-planner:master
    command: python /service/adaptation_planner/run.py
    depends_on:
      - redis

    environment:
      - PYTHONUNBUFFERED=0
      - REDIS_ADDRESS=${REDIS_ADDRESS}
      - REDIS_PORT=${REDIS_PORT}
      - TRACER_REPORTING_HOST=${TRACER_REPORTING_HOST}
      - TRACER_REPORTING_PORT=${TRACER_REPORTING_PORT}
      - SERVICE_STREAM_KEY=${ADAPTATION_PLANNER_STREAM_KEY}
      - LISTEN_EVENT_TYPE_QUERY_CREATED=${EVENT_TYPE_QUERY_CREATED}
      - LISTEN_EVENT_TYPE_SERVICE_WORKERS_STREAM_MONITORED=${EVENT_TYPE_SERVICE_WORKERS_STREAM_MONITORED}
      - LISTEN_EVENT_TYPE_NEW_QUERY_SCHEDULING_PLAN_REQUESTED=${EVENT_TYPE_NEW_QUERY_SCHEDULING_PLAN_REQUESTED}
      - LISTEN_EVENT_TYPE_SERVICE_WORKER_OVERLOADED_PLAN_REQUESTED=${EVENT_TYPE_SERVICE_WORKER_OVERLOADED_PLAN_REQUESTED}
      - LISTEN_EVENT_TYPE_SERVICE_WORKER_BEST_IDLE_REQUESTED=${EVENT_TYPE_SERVICE_WORKER_BEST_IDLE_REQUESTED}
      - LISTEN_EVENT_TYPE_UNNECESSARY_LOAD_SHEDDING_REQUESTED=${EVENT_TYPE_UNNECESSARY_LOAD_SHEDDING_REQUESTED}
      - PUB_EVENT_TYPE_NEW_QUERY_SCHEDULING_PLANNED=${EVENT_TYPE_NEW_QUERY_SCHEDULING_PLANNED}
      - PUB_EVENT_TYPE_SERVICE_WORKER_OVERLOADED_PLANNED=${EVENT_TYPE_SERVICE_WORKER_OVERLOADED_PLANNED}
      - PUB_EVENT_TYPE_SERVICE_WORKER_BEST_IDLE_PLANNED=${EVENT_TYPE_SERVICE_WORKER_BEST_IDLE_PLANNED}
      - PUB_EVENT_TYPE_UNNECESSARY_LOAD_SHEDDING_PLANNED=${EVENT_TYPE_UNNECESSARY_LOAD_SHEDDING_PLANNED}
      - SCHEDULER_PLANNER_TYPE=${SCHEDULER_PLANNER_TYPE}
      - LOGGING_LEVEL=${LOGGING_LEVEL}

  scheduler:
    image: registry.insight-centre.org/sit/mps/felipe-phd/scheduler:master
    command: python /service/scheduler/run.py
    depends_on:
      - redis

    environment:
      - PYTHONUNBUFFERED=0
      - REDIS_ADDRESS=${REDIS_ADDRESS}
      - REDIS_PORT=${REDIS_PORT}
      - TRACER_REPORTING_HOST=${TRACER_REPORTING_HOST}
      - TRACER_REPORTING_PORT=${TRACER_REPORTING_PORT}
      - SERVICE_STREAM_KEY=${SCHEDULER_STREAM_KEY}
      - LISTEN_EVENT_TYPE_NEW_QUERY_SCHEDULING_PLANNED=${EVENT_TYPE_NEW_QUERY_SCHEDULING_PLANNED}
      - LISTEN_EVENT_TYPE_SERVICE_WORKER_OVERLOADED_PLANNED=${EVENT_TYPE_SERVICE_WORKER_OVERLOADED_PLANNED}
      - LISTEN_EVENT_TYPE_SERVICE_WORKER_BEST_IDLE_PLANNED=${EVENT_TYPE_SERVICE_WORKER_BEST_IDLE_PLANNED}
      - LISTEN_EVENT_TYPE_UNNECESSARY_LOAD_SHEDDING_PLANNED=${EVENT_TYPE_UNNECESSARY_LOAD_SHEDDING_PLANNED}
      - PUB_EVENT_TYPE_SCHEDULING_PLAN_EXECUTED=${EVENT_TYPE_SCHEDULING_PLAN_EXECUTED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}

  preprocessor:
    image: registry.insight-centre.org/sit/mps/felipe-phd/preprocessing-service:master
    command: python /service/preprocessing/run.py
    depends_on:
      - redis

    environment:
      - PYTHONUNBUFFERED=0
      - REDIS_ADDRESS=${REDIS_ADDRESS}
      - REDIS_PORT=${REDIS_PORT}
      - TRACER_REPORTING_HOST=${TRACER_REPORTING_HOST}
      - TRACER_REPORTING_PORT=${TRACER_REPORTING_PORT}
      - SERVICE_STREAM_KEY=${PREPROCESSOR_STREAM_KEY}
      - LISTEN_EVENT_TYPE_QUERY_CREATED=${EVENT_TYPE_QUERY_CREATED}
      - LISTEN_EVENT_TYPE_QUERY_REMOVED=${EVENT_TYPE_QUERY_REMOVED}
      - FFMPEG_BIN=/service/ffmpeg_bin/ffmpeg-linux64-v3.3.1
      - REDIS_EXPIRATION_TIME=${REDIS_EXPIRATION_TIME}
      - LOGGING_LEVEL=${LOGGING_LEVEL}

  event-dispatcher:
    image: registry.insight-centre.org/sit/mps/felipe-phd/event-dispatcher:master
    command: python /service/event_dispatcher/run.py
    depends_on:
      - redis

    environment:
      - PYTHONUNBUFFERED=0
      - REDIS_ADDRESS=${REDIS_ADDRESS}
      - REDIS_PORT=${REDIS_PORT}
      - TRACER_REPORTING_HOST=${TRACER_REPORTING_HOST}
      - TRACER_REPORTING_PORT=${TRACER_REPORTING_PORT}
      - SERVICE_STREAM_KEY=${EVENT_DISPATCHER_STREAM_KEY}
      - LISTEN_EVENT_TYPE_QUERY_CREATED=${EVENT_TYPE_QUERY_CREATED}
      - LISTEN_EVENT_TYPE_QUERY_REMOVED=${EVENT_TYPE_QUERY_REMOVED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}

  window-manager:
    image: registry.insight-centre.org/sit/mps/felipe-phd/window-manager:master
    command: python /service/window_manager/run.py
    depends_on:
      - redis

    environment:
      - PYTHONUNBUFFERED=0
      - REDIS_ADDRESS=${REDIS_ADDRESS}
      - REDIS_PORT=${REDIS_PORT}
      - TRACER_REPORTING_HOST=${TRACER_REPORTING_HOST}
      - TRACER_REPORTING_PORT=${TRACER_REPORTING_PORT}
      - SERVICE_STREAM_KEY=${WINDOW_MANAGER_STREAM_KEY}
      - MATCHER_STREAM_KEY=${MATCHER_STREAM_KEY}
      - LISTEN_EVENT_TYPE_QUERY_CREATED=${EVENT_TYPE_QUERY_CREATED}
      - LISTEN_EVENT_TYPE_QUERY_REMOVED=${EVENT_TYPE_QUERY_REMOVED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}

  matcher:
    image: registry.insight-centre.org/sit/mps/felipe-phd/matcher:master
    command: python /service/matcher/run.py
    depends_on:
      - redis

    environment:
      - PYTHONUNBUFFERED=0
      - REDIS_ADDRESS=${REDIS_ADDRESS}
      - REDIS_PORT=${REDIS_PORT}
      - TRACER_REPORTING_HOST=${TRACER_REPORTING_HOST}
      - TRACER_REPORTING_PORT=${TRACER_REPORTING_PORT}
      - SERVICE_STREAM_KEY=${MATCHER_STREAM_KEY}
      - FORWARDER_STREAM_KEY=${FORWARDER_STREAM_KEY}
      - LISTEN_EVENT_TYPE_QUERY_CREATED=${EVENT_TYPE_QUERY_CREATED}
      - LISTEN_EVENT_TYPE_QUERY_REMOVED=${EVENT_TYPE_QUERY_REMOVED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}

  forwarder:
    image: registry.insight-centre.org/sit/mps/felipe-phd/forwarder:master
    command: python /service/forwarder/run.py
    depends_on:
      - redis

    environment:
      - PYTHONUNBUFFERED=0
      - REDIS_ADDRESS=${REDIS_ADDRESS}
      - REDIS_PORT=${REDIS_PORT}
      - TRACER_REPORTING_HOST=${TRACER_REPORTING_HOST}
      - TRACER_REPORTING_PORT=${TRACER_REPORTING_PORT}
      - SERVICE_STREAM_KEY=${FORWARDER_STREAM_KEY}
      - LISTEN_EVENT_TYPE_QUERY_CREATED=${EVENT_TYPE_QUERY_CREATED}
      - LISTEN_EVENT_TYPE_QUERY_REMOVED=${EVENT_TYPE_QUERY_REMOVED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}

